<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–±–ª–∞—á–Ω—ã–π –¢—Ä–µ–∫–µ—Ä QR-–∫–æ–¥–æ–≤</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; margin: 0; background-color: #f4f7f9; color: #333; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; background-color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; }
        h1, h2 { color: #1a2b4d; border-bottom: 2px solid #e1e8ed; padding-bottom: 10px; }
        form { background-color: #fdfdfe; padding: 20px; border-radius: 8px; border: 1px solid #e1e8ed; margin-bottom: 20px; }
        input[type="text"], input[type="url"], input[type="date"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; word-break: break-all; }
        th { background-color: #f2f2f2; }
        tr:hover { background-color: #f5f5f5; }
        .actions-cell { display: flex; gap: 8px; flex-wrap: wrap; }
        .copy-btn, .delete-btn { font-size: 12px; padding: 5px 10px; color: white; border-radius: 4px; cursor: pointer; border: none;}
        .copy-btn { background-color: #28a745; }
        .copy-btn:hover { background-color: #218838; }
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }
        .loader-container, .loading-overlay { text-align: center; padding: 50px; font-size: 20px; display: none; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="loader-container">
        <h1>–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
    </div>

    <div id="redirect-message" class="loader-container">
        <h1>–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</h1>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</p>
    </div>

    <div id="dashboard" class="container" style="display: none;">
        <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–µ—Ä–æ–º</h1>
        <form id="create-link-form">
            <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—É—é —Å—Å—ã–ª–∫—É</h2>
            <input type="text" id="link-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'QR –Ω–∞ –≤–∏–∑–∏—Ç–∫–µ')" required>
            <input type="url" id="destination-url" placeholder="URL –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (https://t.me/...)" required>
            <button type="submit">–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        </form>
        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</h2>
        <div class="filter-section">
             <div class="filter-group"><label for="start-date">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å:</label><input type="date" id="start-date"></div>
             <div class="filter-group"><label for="end-date">–ü–æ:</label><input type="date" id="end-date"></div>
        </div>
        <table>
            <thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–ª–∏–∫–∏ (–∑–∞ –ø–µ—Ä–∏–æ–¥)</th><th>URL –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="stats-table-body"></tbody>
        </table>
    </div>

    <script>
        // ==================================================================
        // –í–ê–®–ò –î–ê–ù–ù–´–ï –£–ñ–ï –í–°–¢–ê–í–õ–ï–ù–´
        // ==================================================================
        // –ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞ –æ—Ç jsonbin.io. –ù–∞–π–¥–∏—Ç–µ –µ–≥–æ –≤ —Ä–∞–∑–¥–µ–ª–µ "API Keys".
        const JSONBIN_ACCESS_KEY = '$2a$10$iluB48AWq0B3yJvnzUY.Ge31LkmZpjnnSmaVXp2FfXsB18AqUhvBO';
        // ID –≤–∞—à–µ–π "–∫–æ—Ä–∑–∏–Ω—ã" (bin) –≤ jsonbin.io. –ï–≥–æ –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ URL –ø–æ—Å–ª–µ /b/
        const JSONBIN_BIN_ID = '6857e0cf8960c979a5aefee2';
        // ==================================================================
        // –í–ê–®–ò –î–ê–ù–ù–´–ï TELEGRAM
        const BOT_TOKEN = '7562433699:AAGQS6SEzs8qPloifYO0_3mTM7jCj29kfW8';
        const CHAT_ID = '711959226';
        // ==================================================================

        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
        let linkData = {};
        const loadingOverlay = document.getElementById('loading-overlay');

        // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±–ª–∞—á–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º ---
        async function getCloudData() {
            loadingOverlay.style.display = 'block';
            try {
                const response = await fetch(`${JSONBIN_URL}/latest`, {
                    headers: { 'X-Access-Key': JSONBIN_ACCESS_KEY }
                });
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${response.status}`);
                }
                const data = await response.json();
                return data.record || {};
            } catch (error) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞:", error);
                if (error.message.includes('401')) {
                    alert("–û—à–∏–±–∫–∞ 401: –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø.\n\n–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤–∞—à API-–∫–ª—é—á (JSONBIN_ACCESS_KEY) –∏–ª–∏ Bin ID –Ω–µ–≤–µ—Ä–Ω—ã, –ª–∏–±–æ —É –∫–ª—é—á–∞ –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ.\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–∞–π—Ç–µ jsonbin.io –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∏—Ö –∑–∞–Ω–æ–≤–æ –≤ –∫–æ–¥.");
                } else if (error.message.includes('404')) {
                    alert("–û—à–∏–±–∫–∞ 404: Bin –Ω–µ –Ω–∞–π–¥–µ–Ω.\n\n–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à Bin ID –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.");
                }
                else {
                    alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–µ–π.");
                }
                return null;
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        async function saveCloudData(data) {
            loadingOverlay.style.display = 'block';
            try {
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Key': JSONBIN_ACCESS_KEY
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ${response.status}`);
                }
            } catch (error) {
                console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–æ:", error);
                if (error.message.includes('401')) {
                    alert("–û—à–∏–±–∫–∞ 401 –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø.\n\n–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤–∞—à API-–∫–ª—é—á (JSONBIN_ACCESS_KEY) –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ —ç—Ç–æ—Ç Bin.");
                } else {
                    alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
                }
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // --- –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Telegram ---
        async function sendTelegramNotification(message) {
            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: CHAT_ID, text: message, parse_mode: 'Markdown' })
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram:', error);
            }
        }

        // --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ---
        window.onload = async function() {
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∫–ª—é—á–∞, —á—Ç–æ–±—ã —Å—Ä–∞–∑—É –≤—ã—è–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É
            if (JSONBIN_ACCESS_KEY.startsWith('$2a$')) {
                alert("–í–ù–ò–ú–ê–ù–ò–ï: –í–∞—à API-–∫–ª—é—á (JSONBIN_ACCESS_KEY) –≤—ã–≥–ª—è–¥–∏—Ç –Ω–µ–≤–µ—Ä–Ω–æ. –û–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å '$2a$'.\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª 'API Keys' –Ω–∞ —Å–∞–π—Ç–µ jsonbin.io –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á 'X-Access-Key'. –û–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª–∏–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π –∏–∑ –±—É–∫–≤ –∏ —Ü–∏—Ñ—Ä.");
                return;
            }

            linkData = await getCloudData();
            if (linkData === null) return;

            const urlParams = new URLSearchParams(window.location.search);
            const trackCode = urlParams.get('track');

            if (trackCode) {
                await handleTracking(trackCode);
            } else {
                initializeDashboard();
            }
        };

        // --- –†–µ–∂–∏–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è ---
        async function handleTracking(code) {
            document.getElementById('redirect-message').style.display = 'block';
            const link = linkData[code];
            if (link) {
                if (!link.clicks) link.clicks = [];
                link.clicks.push(Date.now());
                
                await saveCloudData(linkData); 
                sendTelegramNotification(`üîî *–ù–æ–≤—ã–π –ø–µ—Ä–µ—Ö–æ–¥!*\n\n*–ò—Å—Ç–æ—á–Ω–∏–∫*: ${link.name}`);

                window.location.href = link.destinationUrl;
            } else {
                document.getElementById('redirect-message').innerHTML = '<h1>–û—à–∏–±–∫–∞: –°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h1>';
                sendTelegramNotification(`‚ö†Ô∏è –ö—Ç–æ-—Ç–æ –ø–µ—Ä–µ—à–µ–ª –ø–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Å—ã–ª–∫–µ: *${code}*`);
            }
        }

        // --- –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ ---
        function initializeDashboard() {
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('create-link-form').addEventListener('submit', createNewLink);
            document.getElementById('start-date').addEventListener('change', renderStats);
            document.getElementById('end-date').addEventListener('change', renderStats);
            renderStats();
        }

        async function createNewLink(event) {
            event.preventDefault();
            const name = document.getElementById('link-name').value.trim();
            const url = document.getElementById('destination-url').value.trim();

            if (name && url) {
                const code = name.toLowerCase().replace(/[^a-z0-9–∞-—è—ë]/gi, '-').replace(/-+/g, '-') + '-' + Date.now().toString(36);
                linkData[code] = { name: name, destinationUrl: url, clicks: [] };
                await saveCloudData(linkData);
                renderStats();
                document.getElementById('link-name').value = '';
                document.getElementById('destination-url').value = '';
            }
        }
        
        async function handleDeleteLink(event) {
            const code = event.target.getAttribute('data-code');
            const linkName = linkData[code]?.name || '—ç—Ç—É —Å—Å—ã–ª–∫—É';
            
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É "${linkName}"?`)) {
                delete linkData[code];
                await saveCloudData(linkData);
                renderStats();
            }
        }
        
        function renderStats() {
            const tableBody = document.getElementById('stats-table-body');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            const filterStartTimestamp = startDateInput.value ? new Date(startDateInput.value).getTime() : 0;
            let filterEndTimestamp = Infinity;
            if (endDateInput.value) {
                const endDate = new Date(endDateInput.value);
                endDate.setHours(23, 59, 59, 999);
                filterEndTimestamp = endDate.getTime();
            }
            tableBody.innerHTML = '';
            for (const code in linkData) {
                const link = linkData[code];
                const clicksInPeriod = (link.clicks || []).filter(ts => ts >= filterStartTimestamp && ts <= filterEndTimestamp).length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${link.name}</td>
                    <td><b>${clicksInPeriod}</b></td>
                    <td><a href="${link.destinationUrl}" target="_blank">${link.destinationUrl}</a></td>
                    <td class="actions-cell">
                        <button class="copy-btn" data-code="${code}">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="delete-btn" data-code="${code}">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                `;
                tableBody.appendChild(row);
            }
            document.querySelectorAll('.copy-btn').forEach(b => b.addEventListener('click', copyTrackingLink));
            document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', handleDeleteLink));
        }
        
        function copyTrackingLink(event) {
            const code = event.target.getAttribute('data-code');
            const trackingUrl = `${window.location.href.split('?')[0]}?track=${code}`;
            navigator.clipboard.writeText(trackingUrl).then(() => {
                event.target.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => { event.target.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 2000);
            }).catch(err => prompt('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:', trackingUrl));
        }
    </script>
</body>
</html>
