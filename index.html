<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Облачный Трекер QR-кодов</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; margin: 0; background-color: #f4f7f9; color: #333; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; background-color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; }
        h1, h2 { color: #1a2b4d; border-bottom: 2px solid #e1e8ed; padding-bottom: 10px; }
        form { background-color: #fdfdfe; padding: 20px; border-radius: 8px; border: 1px solid #e1e8ed; margin-bottom: 20px; }
        input[type="text"], input[type="url"], input[type="date"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; word-break: break-all; }
        th { background-color: #f2f2f2; }
        tr:hover { background-color: #f5f5f5; }
        .actions-cell { display: flex; gap: 8px; flex-wrap: wrap; }
        .copy-btn, .delete-btn { font-size: 12px; padding: 5px 10px; color: white; border-radius: 4px; cursor: pointer; border: none;}
        .copy-btn { background-color: #28a745; }
        .copy-btn:hover { background-color: #218838; }
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }
        .loader-container, .loading-overlay { text-align: center; padding: 50px; font-size: 20px; display: none; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="loader-container">
        <h1>Загрузка...</h1>
    </div>

    <div id="redirect-message" class="loader-container">
        <h1>Перенаправление...</h1>
        <p>Пожалуйста, подождите.</p>
    </div>

    <div id="dashboard" class="container" style="display: none;">
        <h1>Панель управления трекером</h1>
        <form id="create-link-form">
            <h2>Создать новую отслеживаемую ссылку</h2>
            <input type="text" id="link-name" placeholder="Название (например, 'QR на визитке')" required>
            <input type="url" id="destination-url" placeholder="URL назначения (https://t.me/...)" required>
            <button type="submit">Создать ссылку</button>
        </form>
        <h2>Статистика переходов</h2>
        <div class="filter-section">
             <div class="filter-group"><label for="start-date">Статистика с:</label><input type="date" id="start-date"></div>
             <div class="filter-group"><label for="end-date">По:</label><input type="date" id="end-date"></div>
        </div>
        <table>
            <thead><tr><th>Название</th><th>Клики (за период)</th><th>URL Назначения</th><th>Действия</th></tr></thead>
            <tbody id="stats-table-body"></tbody>
        </table>
    </div>

    <script>
        // ==================================================================
        // ВАШИ ДАННЫЕ УЖЕ ВСТАВЛЕНЫ
        // ==================================================================
        // Ключ доступа от jsonbin.io. Найдите его в разделе "API Keys".
        const JSONBIN_ACCESS_KEY = '$2a$10$iluB48AWq0B3yJvnzUY.Ge31LkmZpjnnSmaVXp2FfXsB18AqUhvBO';
        // ID вашей "корзины" (bin) в jsonbin.io. Его можно найти в URL после /b/
        const JSONBIN_BIN_ID = '6857e0cf8960c979a5aefee2';
        // ==================================================================
        // ВАШИ ДАННЫЕ TELEGRAM
        const BOT_TOKEN = '7562433699:AAGQS6SEzs8qPloifYO0_3mTM7jCj29kfW8';
        const CHAT_ID = '711959226';
        // ==================================================================

        const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
        let linkData = {};
        const loadingOverlay = document.getElementById('loading-overlay');

        // --- Функции для работы с облачным хранилищем ---
        async function getCloudData() {
            loadingOverlay.style.display = 'block';
            try {
                const response = await fetch(`${JSONBIN_URL}/latest`, {
                    headers: { 'X-Access-Key': JSONBIN_ACCESS_KEY }
                });
                if (!response.ok) {
                    throw new Error(`Ошибка сети: ${response.status}`);
                }
                const data = await response.json();
                return data.record || {};
            } catch (error) {
                console.error("Не удалось получить данные из облака:", error);
                if (error.message.includes('401')) {
                    alert("Ошибка 401: Неавторизованный доступ.\n\nЭто означает, что ваш API-ключ (JSONBIN_ACCESS_KEY) или Bin ID неверны, либо у ключа нет прав на чтение.\n\nПожалуйста, перепроверьте эти данные на сайте jsonbin.io и вставьте их заново в код.");
                } else if (error.message.includes('404')) {
                    alert("Ошибка 404: Bin не найден.\n\nУбедитесь, что ваш Bin ID правильный.");
                }
                else {
                    alert("Ошибка: Не удалось загрузить данные из облака. Проверьте ваше интернет-соединение и правильность ключей.");
                }
                return null;
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        async function saveCloudData(data) {
            loadingOverlay.style.display = 'block';
            try {
                const response = await fetch(JSONBIN_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Key': JSONBIN_ACCESS_KEY
                    },
                    body: JSON.stringify(data)
                });
                if (!response.ok) {
                    throw new Error(`Ошибка сети при сохранении: ${response.status}`);
                }
            } catch (error) {
                console.error("Не удалось сохранить данные в облако:", error);
                if (error.message.includes('401')) {
                    alert("Ошибка 401 при сохранении: Неавторизованный доступ.\n\nЭто означает, что ваш API-ключ (JSONBIN_ACCESS_KEY) не имеет прав на запись в этот Bin.");
                } else {
                    alert("Ошибка: Не удалось сохранить данные. Проверьте интернет-соединение.");
                }
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // --- Функция отправки уведомлений в Telegram ---
        async function sendTelegramNotification(message) {
            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: CHAT_ID, text: message, parse_mode: 'Markdown' })
                });
            } catch (error) {
                console.error('Ошибка отправки уведомления в Telegram:', error);
            }
        }

        // --- Основная логика ---
        window.onload = async function() {
            // ИСПРАВЛЕНО: Добавлена проверка формата ключа, чтобы сразу выявить проблему
            if (JSONBIN_ACCESS_KEY.startsWith('$2a$')) {
                alert("ВНИМАНИЕ: Ваш API-ключ (JSONBIN_ACCESS_KEY) выглядит неверно. Он не должен начинаться с '$2a$'.\n\nПожалуйста, зайдите в раздел 'API Keys' на сайте jsonbin.io и скопируйте ключ 'X-Access-Key'. Он должен быть длинной строкой из букв и цифр.");
                return;
            }

            linkData = await getCloudData();
            if (linkData === null) return;

            const urlParams = new URLSearchParams(window.location.search);
            const trackCode = urlParams.get('track');

            if (trackCode) {
                await handleTracking(trackCode);
            } else {
                initializeDashboard();
            }
        };

        // --- Режим отслеживания ---
        async function handleTracking(code) {
            document.getElementById('redirect-message').style.display = 'block';
            const link = linkData[code];
            if (link) {
                if (!link.clicks) link.clicks = [];
                link.clicks.push(Date.now());
                
                await saveCloudData(linkData); 
                sendTelegramNotification(`🔔 *Новый переход!*\n\n*Источник*: ${link.name}`);

                window.location.href = link.destinationUrl;
            } else {
                document.getElementById('redirect-message').innerHTML = '<h1>Ошибка: Ссылка не найдена</h1>';
                sendTelegramNotification(`⚠️ Кто-то перешел по несуществующей ссылке: *${code}*`);
            }
        }

        // --- Режим администратора ---
        function initializeDashboard() {
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('create-link-form').addEventListener('submit', createNewLink);
            document.getElementById('start-date').addEventListener('change', renderStats);
            document.getElementById('end-date').addEventListener('change', renderStats);
            renderStats();
        }

        async function createNewLink(event) {
            event.preventDefault();
            const name = document.getElementById('link-name').value.trim();
            const url = document.getElementById('destination-url').value.trim();

            if (name && url) {
                const code = name.toLowerCase().replace(/[^a-z0-9а-яё]/gi, '-').replace(/-+/g, '-') + '-' + Date.now().toString(36);
                linkData[code] = { name: name, destinationUrl: url, clicks: [] };
                await saveCloudData(linkData);
                renderStats();
                document.getElementById('link-name').value = '';
                document.getElementById('destination-url').value = '';
            }
        }
        
        async function handleDeleteLink(event) {
            const code = event.target.getAttribute('data-code');
            const linkName = linkData[code]?.name || 'эту ссылку';
            
            if (confirm(`Вы уверены, что хотите удалить ссылку "${linkName}"?`)) {
                delete linkData[code];
                await saveCloudData(linkData);
                renderStats();
            }
        }
        
        function renderStats() {
            const tableBody = document.getElementById('stats-table-body');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            const filterStartTimestamp = startDateInput.value ? new Date(startDateInput.value).getTime() : 0;
            let filterEndTimestamp = Infinity;
            if (endDateInput.value) {
                const endDate = new Date(endDateInput.value);
                endDate.setHours(23, 59, 59, 999);
                filterEndTimestamp = endDate.getTime();
            }
            tableBody.innerHTML = '';
            for (const code in linkData) {
                const link = linkData[code];
                const clicksInPeriod = (link.clicks || []).filter(ts => ts >= filterStartTimestamp && ts <= filterEndTimestamp).length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${link.name}</td>
                    <td><b>${clicksInPeriod}</b></td>
                    <td><a href="${link.destinationUrl}" target="_blank">${link.destinationUrl}</a></td>
                    <td class="actions-cell">
                        <button class="copy-btn" data-code="${code}">Копировать</button>
                        <button class="delete-btn" data-code="${code}">Удалить</button>
                    </td>
                `;
                tableBody.appendChild(row);
            }
            document.querySelectorAll('.copy-btn').forEach(b => b.addEventListener('click', copyTrackingLink));
            document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', handleDeleteLink));
        }
        
        function copyTrackingLink(event) {
            const code = event.target.getAttribute('data-code');
            const trackingUrl = `${window.location.href.split('?')[0]}?track=${code}`;
            navigator.clipboard.writeText(trackingUrl).then(() => {
                event.target.textContent = 'Скопировано!';
                setTimeout(() => { event.target.textContent = 'Копировать'; }, 2000);
            }).catch(err => prompt('Не удалось скопировать. Скопируйте вручную:', trackingUrl));
        }
    </script>
</body>
</html>
