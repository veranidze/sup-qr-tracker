<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–æ–∫–∞–ª—å–Ω—ã–π –¢—Ä–µ–∫–µ—Ä QR-–∫–æ–¥–æ–≤</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; margin: 0; background-color: #f4f7f9; color: #333; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; background-color: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; }
        h1, h2 { color: #1a2b4d; border-bottom: 2px solid #e1e8ed; padding-bottom: 10px; }
        form { background-color: #fdfdfe; padding: 20px; border-radius: 8px; border: 1px solid #e1e8ed; margin-bottom: 20px; }
        input[type="text"], input[type="url"], input[type="date"] { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; word-break: break-all; }
        th { background-color: #f2f2f2; }
        tr:hover { background-color: #f5f5f5; }
        .actions-cell { display: flex; gap: 8px; flex-wrap: wrap; }
        .copy-btn, .delete-btn { font-size: 12px; padding: 5px 10px; color: white; border-radius: 4px; cursor: pointer; border: none;}
        .copy-btn { background-color: #28a745; }
        .copy-btn:hover { background-color: #218838; }
        .delete-btn { background-color: #dc3545; }
        .delete-btn:hover { background-color: #c82333; }
        .loader-container { text-align: center; padding: 50px; font-size: 20px; display: none; }
        .filter-section { display: flex; flex-wrap: wrap; gap: 20px; align-items: center; margin-bottom: 20px; padding: 15px; background-color: #eef3f8; border-radius: 8px; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { margin-bottom: 5px; font-size: 14px; color: #555; }
    </style>
</head>
<body>

    <!-- –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–µ -->
    <div id="redirect-message" class="loader-container">
        <h1>–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</h1>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</p>
    </div>

    <!-- –≠—Ç–æ –æ—Å–Ω–æ–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="dashboard" class="container">
        <h1>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–µ—Ä–æ–º</h1>

        <form id="create-link-form">
            <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—É—é —Å—Å—ã–ª–∫—É</h2>
            <input type="text" id="link-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'QR –Ω–∞ –≤–∏–∑–∏—Ç–∫–µ')" required>
            <input type="url" id="destination-url" placeholder="URL –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è (—Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ https://t.me/...)" required>
            <button type="submit">–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        </form>

        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</h2>
        <div class="filter-section">
             <div class="filter-group">
                <label for="start-date">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å:</label>
                <input type="date" id="start-date">
             </div>
             <div class="filter-group">
                <label for="end-date">–ü–æ:</label>
                <input type="date" id="end-date">
             </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ö–ª–∏–∫–∏ (–∑–∞ –ø–µ—Ä–∏–æ–¥)</th>
                    <th>URL –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="stats-table-body">
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—Ç—Ä–æ–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
            </tbody>
        </table>
    </div>

    <script>
        // ==================================================================
        // –í–ê–®–ò –î–ê–ù–ù–´–ï –£–ñ–ï –í–°–¢–ê–í–õ–ï–ù–´
        // ==================================================================
        const BOT_TOKEN = '7562433699:AAGQS6SEzs8qPloifYO0_3mTM7jCj29kfW8';
        const CHAT_ID = '711959226';
        // ==================================================================

        // --- –õ–û–ö–ê–õ–¨–ù–û–ï –•–†–ê–ù–ò–õ–ò–©–ï –î–ê–ù–ù–´–• (localStorage) ---
        let linkData = JSON.parse(localStorage.getItem('qrLinkTrackerData')) || {};

        function saveData() {
            localStorage.setItem('qrLinkTrackerData', JSON.stringify(linkData));
        }

        // --- –§–£–ù–ö–¶–ò–Ø –û–¢–ü–†–ê–í–ö–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –í TELEGRAM ---
        async function sendTelegramNotification(message) {
            if (!BOT_TOKEN || BOT_TOKEN === '–í–ê–®_–¢–ï–õ–ï–ì–†–ê–ú_–ë–û–¢_–¢–û–ö–ï–ù') {
                console.warn('–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.');
                return;
            }
            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram:', error);
            }
        }

        // --- –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const trackCode = urlParams.get('track');

            if (trackCode) {
                handleTracking(trackCode);
            } else {
                initializeDashboard();
            }
        };

        // --- –†–ï–ñ–ò–ú –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–Ø ---
        async function handleTracking(code) {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('redirect-message').style.display = 'block';

            const link = linkData[code];
            if (link) {
                if (!link.clicks) {
                    link.clicks = [];
                }
                link.clicks.push(Date.now());
                saveData();
                
                const message = `üîî *–ù–æ–≤—ã–π –ø–µ—Ä–µ—Ö–æ–¥!*\n\n*–ò—Å—Ç–æ—á–Ω–∏–∫*: ${link.name}`;
                await sendTelegramNotification(message);

                window.location.href = link.destinationUrl;
            } else {
                document.getElementById('redirect-message').innerHTML = '<h1>–û—à–∏–±–∫–∞: –°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</h1>';
                await sendTelegramNotification(`‚ö†Ô∏è –ö—Ç–æ-—Ç–æ –ø–µ—Ä–µ—à–µ–ª –ø–æ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Å—ã–ª–∫–µ: *${code}*`);
            }
        }

        // --- –†–ï–ñ–ò–ú –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê ---
        function initializeDashboard() {
            const createLinkForm = document.getElementById('create-link-form');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');

            createLinkForm.addEventListener('submit', createNewLink);
            startDateInput.addEventListener('change', renderStats);
            endDateInput.addEventListener('change', renderStats);

            renderStats();
        }

        function createNewLink(event) {
            event.preventDefault();
            const nameInput = document.getElementById('link-name');
            const urlInput = document.getElementById('destination-url');

            const name = nameInput.value.trim();
            const url = urlInput.value.trim();

            if (name && url) {
                const code = name.toLowerCase().replace(/[^a-z0-9–∞-—è—ë]/gi, '-').replace(/-+/g, '-') + '-' + Date.now().toString(36);
                
                linkData[code] = {
                    name: name,
                    destinationUrl: url,
                    clicks: []
                };
                saveData();
                renderStats();

                nameInput.value = '';
                urlInput.value = '';
            }
        }

        function renderStats() {
            const tableBody = document.getElementById('stats-table-body');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            
            const filterStartTimestamp = startDateInput.value ? new Date(startDateInput.value).getTime() : 0;
            
            let filterEndTimestamp = Infinity;
            if (endDateInput.value) {
                const endDate = new Date(endDateInput.value);
                endDate.setHours(23, 59, 59, 999);
                filterEndTimestamp = endDate.getTime();
            }

            tableBody.innerHTML = '';

            for (const code in linkData) {
                const link = linkData[code];
                
                const clicksInPeriod = (link.clicks || []).filter(timestamp => 
                    timestamp >= filterStartTimestamp && timestamp <= filterEndTimestamp
                ).length;

                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${link.name}</td>
                    <td><b>${clicksInPeriod}</b></td>
                    <td><a href="${link.destinationUrl}" target="_blank">${link.destinationUrl}</a></td>
                    <td class="actions-cell">
                        <button class="copy-btn" data-code="${code}">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="delete-btn" data-code="${code}">–£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                `;
                tableBody.appendChild(row);
            }
            
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', copyTrackingLink);
            });

            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDeleteLink);
            });
        }
        
        function copyTrackingLink(event) {
            const code = event.target.getAttribute('data-code');
            const trackingUrl = `${window.location.href.split('?')[0]}?track=${code}`;
            
            navigator.clipboard.writeText(trackingUrl).then(() => {
                event.target.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => { event.target.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 2000);
            }).catch(err => {
                prompt('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:', trackingUrl);
            });
        }

        function handleDeleteLink(event) {
            const code = event.target.getAttribute('data-code');
            const linkName = linkData[code]?.name || '—ç—Ç—É —Å—Å—ã–ª–∫—É';
            
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å—Å—ã–ª–∫—É "${linkName}"? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ –∫–ª–∏–∫–∞—Ö –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.`)) {
                delete linkData[code]; // –£–¥–∞–ª—è–µ–º –∫–ª—é—á –∏–∑ –æ–±—ä–µ–∫—Ç–∞
                saveData(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ localStorage
                renderStats(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            }
        }
    </script>
</body>
</html>
